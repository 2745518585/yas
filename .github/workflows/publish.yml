name: Publish Build

on:
  push:
    tags:
      - '*'
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always

jobs:
  build:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0 # For $commitCount
          lfs: true

      # - uses: actions/cache@v4
      #   with:
      #     path: |
      #       ~/.cargo/bin/
      #       ~/.cargo/registry/index/
      #       ~/.cargo/registry/cache/
      #       ~/.cargo/git/db/
      #       target/
      #     key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Extract git-rev
        run: |
          $commitCount = git rev-list --count HEAD
          $shortHash = git rev-parse --short HEAD
          "GIT_REV=r$commitCount.$shortHash" | Out-File -FilePath $env:GITHUB_ENV -Append

      - name: Setup Toolchain
        run: rustup default nightly-msvc

      # - name: Set version in Cargo.toml
      #   run: |
      #     $files = @(
      #         './Cargo.toml'
      #         './yas/Cargo.toml'
      #         './yas-genshin/Cargo.toml'
      #         './yas-starrail/Cargo.toml'
      #         './yas-application/Cargo.toml'
      #     )
      #     [regex]$pattern = '(?<=version = ").*(?=")'
      #     foreach ($file in $files) {
      #         $pattern.Replace((Get-Content -Raw $file), "0.0.0-$env:GIT_REV", 1) | Out-File -FilePath $file
      #     }

      - name: Build (Release)
        run: cargo build --release

      - name: Rename Outputs
        run: |
          Move-Item ./target/release/yas_artifact.exe "yas_artifact_${{ github.ref_name }}.exe"
      
      - name: Upload Release
        uses: ncipollo/release-action@v1.12.0
        with:
          artifacts: 'yas_artifact_${{ github.ref_name }}.exe'
          token: ${{ secrets.GITHUB_TOKEN }}
          allowUpdates: true